/* ---------- Táblák törlése ---------- */
DROP TABLE kurzus;
DROP TABLE terem;
DROP TABLE kotelezo;
DROP TABLE elofeltetel;
DROP TABLE felvette;
DROP TABLE komment;
DROP TABLE poszt;
DROP TABLE tantargy;
DROP TABLE Felhasznalo;
DROP TABLE szak;

/* ---------- Táblák létrehozása ---------- */
CREATE TABLE felhasznalo (
    PS_kod VARCHAR2(20) NOT NULL,
    nev VARCHAR2(50) NOT NULL,
    email VARCHAR2(50) NOT NULL,
    jelszo VARCHAR2(500) NOT NULL,
    szak_id NUMBER NOT NULL,
    jogosultsag VARCHAR2(50) NOT NULL,
    kezdes_eve DATE,
    vegzes_ideje DATE
);

CREATE TABLE szak (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    nev VARCHAR2(50) NOT NULL UNIQUE
);

CREATE TABLE tantargy (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    nev VARCHAR2(50) NOT NULL,
    targyfelelos VARCHAR2(20) NOT NULL
);
-- TODO: tárgyfelelős egy valid user legyen (ps-kód, foreign key) 

CREATE TABLE kurzus (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    nev VARCHAR2(50) NOT NULL,
    oktato_PS_kod VARCHAR2(20) NOT NULL,
    kezdes_ideje_nap DATE NOT NULL,
    kezdes_ideje_idopont TIMESTAMP NOT NULL,
    tantargy_id NUMBER NOT NULL,
    terem_id NUMBER NOT NULL,
    felveheto CHAR(1) NOT NULL,
    vizsga CHAR(1) NOT NULL
);

CREATE TABLE terem (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    ferohely NUMBER NOT NULL
);

CREATE TABLE kotelezo (
    szak_id NUMBER NOT NULL,
    tantargy_id NUMBER NOT NULL
);

CREATE TABLE elofeltetel (
    tantargy_id NUMBER NOT NULL,
    feltetel_id NUMBER NOT NULL
);

CREATE TABLE felvette (
    PS_kod VARCHAR2(20) NOT NULL,
    tantargy_id NUMBER NOT NULL,
    allapot VARCHAR(20) NOT NULL,
    jegy NUMBER NOT NULL
);
-- TODO: alapból nem lesz bent a jegy, szóval az lehet null

CREATE TABLE poszt (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    PS_kod VARCHAR(20) NOT NULL,
    tartalom VARCHAR(250) NOT NULL
);

CREATE TABLE komment (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    poszt_id NUMBER NOT NULL,
    PS_kod VARCHAR(20) NOT NULL,
    tartalom VARCHAR(200)
);
-- ne csak 20 karakternyit lehessen kommentelni

/* ---------- Elsőfleges kulcsok hozzárendelése táblákhoz ---------- */
ALTER TABLE felhasznalo ADD CONSTRAINT felhasznalo_pk PRIMARY KEY (PS_kod);
ALTER TABLE szak ADD CONSTRAINT szak_pk PRIMARY KEY (id);
ALTER TABLE tantargy ADD CONSTRAINT tantargy_pk PRIMARY KEY (id);
ALTER TABLE kurzus ADD CONSTRAINT kurzus_pk PRIMARY KEY (id);
ALTER TABLE terem ADD CONSTRAINT terem_pk PRIMARY KEY (id);
ALTER TABLE kotelezo ADD CONSTRAINT kotelezo_pk PRIMARY KEY (szak_id, tantargy_id);
ALTER TABLE elofeltetel ADD CONSTRAINT elofeltetel_pk PRIMARY KEY (tantargy_id, feltetel_id);
ALTER TABLE felvette ADD CONSTRAINT felvette_pk PRIMARY KEY (PS_kod, tantargy_id);
ALTER TABLE poszt ADD CONSTRAINT poszt_pk PRIMARY KEY (id);
ALTER TABLE komment ADD CONSTRAINT komment_pk PRIMARY KEY (id);

/* ---------- Külső kulcsok hozzárendelése táblákhoz ---------- */
ALTER TABLE felhasznalo ADD CONSTRAINT felhasznalo_fk1 FOREIGN KEY(szak_id) REFERENCES szak(id) on delete cascade;
ALTER TABLE kurzus ADD CONSTRAINT kurzus_fk1 FOREIGN KEY(tantargy_id) REFERENCES tantargy(id) on delete cascade;
ALTER TABLE kurzus ADD CONSTRAINT kurzus_fk2 FOREIGN KEY(terem_id) REFERENCES terem(id) on delete set null;
-- egy kurzus áthelyezhető másik terembe is, így legyen inkább set null
ALTER TABLE kotelezo ADD CONSTRAINT kotelezo_fk1 FOREIGN KEY(szak_id) REFERENCES szak(id) on delete cascade;
ALTER TABLE kotelezo ADD CONSTRAINT kotelezo_fk2 FOREIGN KEY(tantargy_id) REFERENCES tantargy(id) on delete cascade;
ALTER TABLE elofeltetel ADD CONSTRAINT elofeltetel_fk1 FOREIGN KEY(tantargy_id) REFERENCES tantargy(id) on delete cascade;
ALTER TABLE elofeltetel ADD CONSTRAINT elofeltetel_fk2 FOREIGN KEY(feltetel_id) REFERENCES tantargy(id) on delete cascade;
ALTER TABLE felvette ADD CONSTRAINT felvette_fk1 FOREIGN KEY(PS_kod) REFERENCES felhasznalo(PS_kod) on delete cascade;
ALTER TABLE felvette ADD CONSTRAINT felvette_fk2 FOREIGN KEY(tantargy_id) REFERENCES tantargy(id) on delete cascade;
ALTER TABLE poszt ADD CONSTRAINT poszt_fk1 FOREIGN KEY(PS_kod) REFERENCES felhasznalo(PS_kod) on delete cascade;
ALTER TABLE komment ADD CONSTRAINT komment_fki1 FOREIGN KEY(poszt_id) REFERENCES poszt(id) on delete cascade;
ALTER TABLE komment ADD CONSTRAINT komment_fki2 FOREIGN KEY(PS_kod) REFERENCES felhasznalo(PS_kod) on delete cascade;
